# SPDX-FileCopyrightText: 2022 Demerzel Solutions Limited
# SPDX-License-Identifier: LGPL-3.0-only

FROM --platform=$BUILDPLATFORM mcr.microsoft.com/dotnet/sdk:7.0 AS build

ARG TARGETPLATFORM
ARG TARGETOS
ARG TARGETARCH
ARG BUILDPLATFORM
ARG BUILD_CONFIG=release
ARG BUILD_TIMESTAMP
ARG COMMIT_HASH
ARG ENABLE_PYROSCOPE=0
ARG PYROSCOPE_APP_NAME
ARG PYROSCOPE_SERVER_URL
ARG PYROSCOPE_USER
ARG PYROSCOPE_PASSWORD

COPY . .

RUN if [ "$TARGETARCH" = "amd64" ]; \
    then \
      dotnet tool install JetBrains.dotTrace.GlobalTools --version 2022.3.3 --tool-path /tmp/ && \
      dotnet add src/Nethermind/Nethermind.Runner package JetBrains.dotMemory.Console.$TARGETOS-x64 \
        --version 2022.3.3 --package-directory /tmp/ && \
      dotnet publish src/Nethermind/Nethermind.Runner -c $BUILD_CONFIG -r $TARGETOS-x64 -o out --sc false \
        -p:BuildTimestamp=$BUILD_TIMESTAMP -p:Commit=$COMMIT_HASH ; \
    else \
      dotnet tool install JetBrains.dotTrace.GlobalTools --version 2022.3.3 --tool-path /tmp/ && \
      dotnet add src/Nethermind/Nethermind.Runner package JetBrains.dotMemory.Console.$TARGETOS-$TARGETARCH \
        --version 2022.3.3 --package-directory /tmp/ && \
      dotnet publish src/Nethermind/Nethermind.Runner -c $BUILD_CONFIG -r $TARGETOS-$TARGETARCH -o out --sc false \
        -p:BuildTimestamp=$BUILD_TIMESTAMP -p:Commit=$COMMIT_HASH ; \
    fi

RUN dotnet tool install --tool-path /dotnetcore-tools dotnet-trace && \
    dotnet tool install --tool-path /dotnetcore-tools dotnet-dump && \
    dotnet tool install --tool-path /dotnetcore-tools dotnet-gcdump

RUN apt-get update && apt-get install -y wget && \
    mkdir -p /dotnet && \
    wget -qO- https://github.com/grafana/pyroscope-dotnet/releases/download/v0.8.8-pyroscope/pyroscope.0.8.8-glibc-x86_64.tar.gz | tar xvz -C /dotnet

ENV CORECLR_ENABLE_PROFILING=$ENABLE_PYROSCOPE
ENV CORECLR_PROFILER={BD1A650D-AC5D-4896-B64F-D6FA25D6B26A}
ENV CORECLR_PROFILER_PATH=/dotnet/Pyroscope.Profiler.Native.so
ENV LD_PRELOAD=/dotnet/Pyroscope.Linux.ApiWrapper.x64.so
ENV PYROSCOPE_APPLICATION_NAME=${PYROSCOPE_APP_NAME}
ENV PYROSCOPE_SERVER_ADDRESS=${PYROSCOPE_SERVER_URL}
ENV PYROSCOPE_LOG_LEVEL=debug
ENV PYROSCOPE_PROFILING_ENABLED=$ENABLE_PYROSCOPE
ENV PYROSCOPE_PROFILING_ALLOCATION_ENABLED=true
ENV PYROSCOPE_PROFILING_CONTENTION_ENABLED=true
ENV PYROSCOPE_PROFILING_EXCEPTION_ENABLED=true
ENV PYROSCOPE_BASIC_AUTH_USER=${PYROSCOPE_USER}
ENV PYROSCOPE_BASIC_AUTH_PASSWORD=${PYROSCOPE_PASSWORD}

FROM --platform=$TARGETPLATFORM mcr.microsoft.com/dotnet/aspnet:7.0

RUN apt-get update && apt-get -y install libsnappy-dev procps && \
    rm -rf /var/lib/apt/lists/*

WORKDIR /nethermind

COPY --from=build /out .
COPY --from=build /dotnetcore-tools /opt/dotnetcore-tools
COPY --from=build /tmp/jetbrains.dotmemory.console.* /opt/tools
COPY --from=build /tmp/dottrace /opt/tools
COPY --from=build /tmp/.store /opt/tools/.store

ENV PATH="/opt/dotnetcore-tools:${PATH}"

LABEL git_commit=$COMMIT_HASH

EXPOSE 8545 8551 30303

VOLUME /nethermind/nethermind_db
VOLUME /nethermind/logs
VOLUME /nethermind/keystore

ENTRYPOINT ["./nethermind"]
