// SPDX-FileCopyrightText: 2023 Demerzel Solutions Limited
// SPDX-License-Identifier: LGPL-3.0-only

using System.Collections.Generic;
using Nethermind.Db;
using Nethermind.Db.Rocks.Config;
using Nethermind.Db.Rocks;
using Nethermind.Logging;
using Nethermind.TxPool;
using NUnit.Framework;
using System;
using MathNet.Numerics.Random;
using System.Threading.Tasks;
using Nethermind.Serialization.Rlp;
using Org.BouncyCastle.Utilities.Encoders;

namespace Nethermind.Merge.Plugin.Test;

[TestFixture]
[Parallelizable(ParallelScope.Self)]
public class ProcessedTransactionsDbCleanerTests
{

    [Test]
    public async Task should_remove_processed_txs_from_db_after_finalization()
    {
        var data = Hex.Decode("f90fccf90260a00b86486bb76f473425d57a1a17897aefb3cd048f215e4632fa3b582af8714e40a01dcc4de8dec75d7aab85b567b6ccd41ad312451b948a7413f0a142fd40d4934794ad01b55d7c3448b8899862eb335fbb17075d8de2a04f3c18ffee347094c6fefdd1bd7f27ead2cc67622dc298340ece8c98559c67d1a050b4dc49164875beea385396b51f629947059e0047a5daeceb20903876bae9eca0b7f4c27f5cc5df8a0275907d4d67d74a074383cdace96a2a57933529ed49421bb901000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000040000000080000000000002000000000000000000000000000000000000000000000000004000000040000000000000000000000000000000000000000000000100000000020000000000000000000000000000000002000000000000000000000000000080000000000000000000000000000000000000000000000000000000000000400000000000000000000000000000000001000000000000000000000000000000000000000040000000000000000000000000000000000000000000080830479a58401c9c3808312630f84659f680899d883010d05846765746888676f312e32312e35856c696e7578a0d7bba3c06aefad84061a5c0d16464d56c3e8e18bbb621db81e8602a2226e85cb88000000000000000008a0786bfa72df6c1c5c090a6b4325cc085dff0fd59f805919f44a312c00ca8fcd80830c00008402be0000a039794280c1488d3bfb504d078e5c8e3e3e6904a3bb5197dca6a6a18b62459e0ef90b62b8f101f8ee8501a1f0ff4682180c8477359407830186a094f7273dc463bf257ff350656731af2dda2511bb1680b8807fc53d7a24b6e3ae9cb4f8d3d253eaa7d06538e8ef58908647b7577530db2b4f9760c0527fe81890a29876dd5e830d78d222c10d063deee85f015981d769915ed7c69adf0e60e052605b61010053e0e4d7711c7fc9ce11fc6309acc24b36a62151fe3b66ef1d07d6dc369d024784101622f33268604a527f1a91a4abb6a1905cc001a0d2db40a49f119c768a26e01ee74dd7a6df0b945c2cc5790c24fcf8f17bed1996a06773c81e40cfe745d815a3ffd35991b20b00302b27ae41ca14d11d2f1122e0cfb87101f86e8501a1f0ff4682180d8477359407830186a0940000000000000000000000000000000000000000808180c080a02a1e8efbb37a9b3fcda71c69c133e5b724862a03c329946e6f9948d45fb24bf0a02021c5ba7a7ccd3923629ea63b8e9e20f6a45c58e654432c9a8fe80846e82672b8dd01f8da8501a1f0ff4682180e8477359407830186a08080b8807f55961a9e561c162979cb6363ce6d016044ef783488ec80e703ed1355cff30eed6003527f63d5e30290209dd82cb132adc9a4d1bd7b8d8e1752379606d46d7734398d65576023527f4619938e2a5e5e14273dd3f1dae783ad18ab3d673a19ac569359d1bb847988146043527ff31172be1f7bfd5384b45b205afebb256d9e18c001a0c0280a62c191ac095aef3a56627640f11622183b9a70c0087abbfb9e47e15c0aa041a2d80550d85c90f881e93479be16398c57036fb88ab703134bd2b89319493eb9011d03f901198501a1f0ff4682230484773594008477359407830186a094000000000000000000000000000000000000000080b880600060be55600060b0557f0b93acdc011e0ca3934a64cc229e05fd06bf24009085b3c30a648d65e3a8a6cd6071527f4f0d71ebcc08f7405ba6907574e366aeade1bd816ba8ba3ee44c2cb284ec61dc6091527f722a85e51149974169176d00a5c7e0ad2c21ec1ca75eb9d6f102c75c46ccfc9660b1527ea6a9139944ba38653dc0830f4240e1a001968940265e72bfff0acc0c0c1eba339075bf834e8947296df95f80af0ee3fc80a0a8ebbfdda3eb659ff5cf6839145c4351a546838a729e7910e619eee8eaa7ccc0a01ea6368a1a7eb0b85630b07922923d1e66c3e6b837462767816684bb2a6c984cb9011d03f901198501a1f0ff4682182a84773594008477359407830186a094000000000000000000000000000000000000000080b8803c7f0e1864d8cc8d848a000ebc0d422b1bb783c6b2f4c890ad6470b620daf4b96ab6603d5260e9605d53605a605e536096605f53605460605360316061536043606253606460635360216064536038606553603c606653605360675360da60685339023d6000593e596000208055f016600060ed557fb147b3a0f4d510b4409ec0830f4240e1a0016479e112c502eb326c94882b2e1caa3ccf1315df158a970f7fbb9bba60d2f001a05843ca5958e5f02202ea3dd86eaa658f2b47eab7b02b7f3473b6a343caf4fec6a039a3c2a97f6d8543ac0d7fd181c6db8fed615153515c9b6511942db5e2d1e02db9011d03f901198501a1f0ff4682182b84773594008477359407830186a0941a1c111584458278e383ada5a2f834a1b1e04dee80b880ed9e600060e6557fdfcc871320d6092bd2f16cb79e6e2840070043bb0910361d21ce1cd937b60fee60c7527f9db81e486864bbd5f558b16b84865e787c95b7f23867ca327d5607377b72737160e7527f211f3f1f6ef637be5a2ad07dcadeaabd751d0053bfa4b2dddae9a997f1450fc361010752601461012753604d61012853c0830f4240e1a0018e44be81d05aa685944e81a1350d82fb56c573a85310d56acc28df3de246f301a0ff283b59f98b1139b3f0a31a2b1c7be7502668ace79dfa2935ff94d78fe46359a050f5aff1bfd7e5dce88729bad4e0695a9e0d1c29f84fc308927a58a364d6da71b9011d03f901198501a1f0ff4682182c84773594008477359407830186a094b02a2eda1b317fbd16760128836b0ac59b560e9d80b8807f077f63016c0a720ba3f5aefefa1243e3f4fefde6922b51c25b3003adb5aa261d609952603c60b953606060ba5360b360bb5360bc60bc53602560bd5360cf60be53608760bf5360b360c053605560c153608160c253603c60c353605160c453607060c553602e60c65360da60c753601560c85360dc60c953607f60ca53602ec0830f4240e1a00160741c9531e4faf66c5acbb4dedc7ad3befe7852484d99f81d262f9095ae9880a0538a61f1420690877fd080a2f0b756a7b79f6648f1c4345b170f4c57ea9f3b69a03efaf8a31aad3ce3293d8629bbc7c5d149917f168b4116cf8921688fff26ffe8b9011d03f901198501a1f0ff4682182d84773594008477359407830186a094000000000000000000000000000000000000000080b88060006089556000609b553589d16000601f556000600b556000605d557f374d540ecc34bab346a251aa2d6759bb372a277a26b3a28cb07d30216f9089a1608a527f98878e156f2ad5977d5585dc0f22b9027ad7738cb0e3375d69ad3d03c4efbbfd60aa5260e760ca5360a860cb53600460cc5360f360cd53602560ce53607860c0830f4240e1a0010116f1f4bbde066a6b23158242309756cc7585b185500d63bbaa9fc85727c580a066507c691069d368d4ee3953589808d126dc6b8646715e74e3bc8bbce3b9ea73a02cea3db1e2fb6b5a32b1e29fd1b946d58de0045f60dc56cd3325e7053806714db9011d03f901198501a1f0ff4682182e84773594008477359407830186a094000000000000000000000000000000000000000080b880c53d6000593e5960002080557f0dbda90be1ec6e5a861098ab0b9800cd9278454d24f4fbe85d6ca44355a8750660df527fe98fccc09d6871a90d6c38b3da2b4dd61913fffef69cbc943d4e944b318cc00660ff5260c361011f5360376101205360d86101215360286101225360e26101235360d86101245360a9610125536094c0830f4240e1a001cf9dd18b5b21b721dd89cb679598297488fc075a841d50a281342c1fea068d80a092447fd05863861ce7f20775325e21b7fce5bd59c9a40089e5ab54c03532df31a07852dad57788b98035bf4c2a4f7a8a4a218e7210cb21194913465af1f5055f58b87802f8758501a1f0ff460f843b9aca0085012a05f200830f42409401cedaed8b3e649201e7fcbceeabd6fe40d552f18084bacbe771c080a06f29218f1da146d291f56538cf2356263fb5182fe5c381cf666e3aeaa90825f6a019b6ee71e3264be231c521dd82f22e37d49fba0ffbf91daf9ccad51ed995f5b6b87802f8758501a1f0ff4610843b9aca0085012a05f200830f42409401cedaed8b3e649201e7fcbceeabd6fe40d552f18084c6054dc8c001a04bd672ede4fb79adfa3417b4f525b7afe9ed556da49ce2a2072477450e6ee473a049abd10a9752849392a160c5c506921d070f4dfb376f8b11fbdbca3dda430694b87802f8758501a1f0ff4611843b9aca0085012a05f200830f42409401cedaed8b3e649201e7fcbceeabd6fe40d552f18084c25db486c001a097ff9f475610a41f862856569507b7f9e55a9438cc9c246c6c71616ad337890ba041105930d86e5fde50e8dd5113f140f917be35162424b1270a405977afa03a14b87802f8758501a1f0ff4612843b9aca0085012a05f200830f42409401cedaed8b3e649201e7fcbceeabd6fe40d552f18084bacbe771c080a0c608589ec073b22c0dbae9c1767264f88dbc803bf575949bf79b2bc967deca46a0099ddc5ded5db9521f4217780bd581c9a428a02969ca21de6d82c7dac4aa516ab87302f8708501a1f0ff4682db3a800882520894f4e8263979a89dc357d7f9f79533febc7f3e287b87050c96de68db2680c001a0247198d88ebce250d85b8b8179dc95a8b1aeb97ebaf33bc79fbd3b35b0a10f34a019ccc6c92b65c2056d6f8a31bb893c2c7a93fe4e4c2911c9f649de0382193e82c0f90200df833b9eb0820aa494388ea662ef2c223ec0b047d41bf3c0f362142ad5820a26df833b9eb1820ab294388ea662ef2c223ec0b047d41bf3c0f362142ad5820513df833b9eb2820ac194388ea662ef2c223ec0b047d41bf3c0f362142ad5820513df833b9eb3820ac894388ea662ef2c223ec0b047d41bf3c0f362142ad5820513df833b9eb4820ac994388ea662ef2c223ec0b047d41bf3c0f362142ad5820513df833b9eb5820ad094388ea662ef2c223ec0b047d41bf3c0f362142ad5820513df833b9eb6820ae094388ea662ef2c223ec0b047d41bf3c0f362142ad5820513df833b9eb7820ae294388ea662ef2c223ec0b047d41bf3c0f362142ad5820513df833b9eb8820ae394388ea662ef2c223ec0b047d41bf3c0f362142ad5820513df833b9eb9820aea94388ea662ef2c223ec0b047d41bf3c0f362142ad5820513df833b9eba820aee94388ea662ef2c223ec0b047d41bf3c0f362142ad5820513df833b9ebb820afb94388ea662ef2c223ec0b047d41bf3c0f362142ad5820513df833b9ebc820afd94388ea662ef2c223ec0b047d41bf3c0f362142ad5820513df833b9ebd820b0b94388ea662ef2c223ec0b047d41bf3c0f362142ad5820513df833b9ebe820b1994388ea662ef2c223ec0b047d41bf3c0f362142ad5820513df833b9ebf820b1d94388ea662ef2c223ec0b047d41bf3c0f362142ad5820513");
        var block = new BlockDecoder().Decode(new RlpStream(data));

        IColumnsDb<BlobTxsColumns> columnsDb = new ColumnsDb<BlobTxsColumns>("F:/db/x", StandardDbInitializer.BuildDbSettings(DbNames.BlobTransactions, () => { }, () => { }),
             new DbConfig()
             {
                 AdditionalRocksDbOptions = new Dictionary<string, string> { { "periodic_compaction_seconds", "5" }, { "disable_auto_compactions", "false" } },
             }, LimboLogs.Instance, new List<BlobTxsColumns>() { BlobTxsColumns.FullBlobTxs, BlobTxsColumns.LightBlobTxs, BlobTxsColumns.ProcessedTxs });
        BlobTxStorage blobTxStorage = new(columnsDb);


        var d = columnsDb.GetColumnDb(BlobTxsColumns.FullBlobTxs);
        var bytes = new Random().NextBytes(1024 * 1024 * 100);

        for (int i = 0; i < 10; i++)
        {
            var key = new byte[32];
            key[0] = (byte)i;
            d.Set(key, bytes, Core.WriteFlags.None);
        }

        d.Flush();
        for (int i = 0; i < 10; i++)
        {
            var key = new byte[32];
            key[0] = (byte)i;
            d.Remove(key);
        }

        blobTxStorage.AddBlobTransactionsFromBlock(blockOfTxs, txs);

        blobTxStorage.TryGetBlobTransactionsFromBlock(blockOfTxs, out Transaction[]? returnedTxs).Should().BeTrue();
        returnedTxs!.Length.Should().Be(2);

        IBlockFinalizationManager finalizationManager = Substitute.For<IBlockFinalizationManager>();
        ProcessedTransactionsDbCleaner dbCleaner = new(finalizationManager, columnsDb.GetColumnDb(BlobTxsColumns.ProcessedTxs), _logManager);

        finalizationManager.BlocksFinalized += Raise.EventWith(
            new FinalizeEventArgs(Build.A.BlockHeader.TestObject,
                Build.A.BlockHeader.WithNumber(finalizedBlock).TestObject));

        await dbCleaner.CleaningTask;

        blobTxStorage.TryGetBlobTransactionsFromBlock(blockOfTxs, out returnedTxs).Should().Be(blockOfTxs > finalizedBlock);
        d.Flush();
        await Task.Delay(100_000);
        d.Compact();
    }
}
